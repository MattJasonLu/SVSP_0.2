<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.QuestionnaireMapper">
    <resultMap type="Questionnaire" id="getQuestionnaireRM">
        <result property="applyState" column="state" javaType="com.jdlink.domain.ApplyState" typeHandler="com.jdlink.util.EnumTypeHandler"/>
    </resultMap>
    <insert id="add" parameterType="Questionnaire" >
        insert into questionnaire ( questionnaireId, clientId, evaluationnaireId, time, author, state )
        values ( #{questionnaireId}, #{clientId}, #{evaluationnaireId} ,#{time}, #{author}, 1 );

        <if test="rawWastesList.size() > 0">
            insert into r_questionnaireAndRawWastes (questionnaireId,rawWastesId)
            values
            <foreach collection="rawWastesList" item="rawWastes" index="index" separator="," close=";">
                (#{questionnaireId,jdbcType=VARCHAR},#{rawWastes.materialId,jdbcType=VARCHAR})
            </foreach>
        </if>
        <if test="wasteInclusionTypeList != null and wasteInclusionTypeList.size() > 0">
            insert into r_questionnaireAndWasteInclusionType (questionnaireId, wasteInclusionTypeId)
            values
            <foreach collection="wasteInclusionTypeList" item="wasteInclusionType" index="index" separator="," close=";">
                (#{materialId,jdbcType=VARCHAR},#{wasteInclusionType.index,jdbcType=INTEGER})
            </foreach>
        </if>
        <if test="wasteProcessList.size() > 0">
            insert into r_questionnaireAndWasteProcess (questionnaireId,wasteProcessId)
            values
            <foreach collection="wasteProcessList" item="wasteProcess" index="index" separator="," close=";">
                (#{questionnaireId,jdbcType=VARCHAR},#{wasteProcess.processId,jdbcType=VARCHAR})
            </foreach>
        </if>

        <if test="deriveWastesList.size() > 0">
            insert into r_questionnaireAndDeriveWastes (questionnaireId,deriveWastesId)
            values
            <foreach collection="deriveWastesList" item="deriveWastes" index="index" separator="," close=";">
                (#{questionnaireId,jdbcType=VARCHAR},#{deriveWastes.id,jdbcType=VARCHAR})
            </foreach>
        </if>

    </insert>

    <delete id="delete" parameterType="Questionnaire" >
        delete from questionnaire where questionnaireId= #{questionnaireId}
    </delete>

    <select id="get" parameterType="String" resultType="Questionnaire">
        select * from questionnaire where clientId = #{0} and questionnaireId like "%"#{1}"%"
    </select>

    <select id="getByClientId" parameterType="String" resultType="Questionnaire">
        SELECT * FROM questionnaire WHERE clientId = #{clientId}
    </select>

    <update id="update" parameterType="Questionnaire" >
        update questionnaire set clientId=#{clientId} where questionnaireId=#{questionnaireId}
    </update>

    <update id="signIn" parameterType="String">
        UPDATE questionnaire SET state=2 WHERE questionnaireId=#{quesionnaireId}
    </update>

    <update id="back" parameterType="String">
        UPDATE questionnaire SET state=3 WHERE questionnaireId=#{quesionnaireId}
    </update>

    <select id="list" resultType="Questionnaire" resultMap="getQuestionnaireRM">
        select * from questionnaire
    </select>
</mapper>